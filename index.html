<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Competencia Oficial Primera C</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0e1a;
            color: #ffffff;
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d3561 100%);
            padding: 20px 0;
            border-bottom: 3px solid #ffd700;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #1a1f3a;
        }

        .title-section h1 {
            font-size: 28px;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .title-section .subtitle {
            font-size: 14px;
            color: #a0aec0;
            font-weight: 400;
        }

        .header-stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #ffd700;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Sistema de Usuario */
        .user-section {
            background: #1a202c;
            margin: 20px auto;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #2d3748;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .auth-form {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .auth-input {
            background: #2d3748;
            border: 2px solid #4a5568;
            color: #ffffff;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 16px;
            min-width: 250px;
            transition: border-color 0.3s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: #ffd700;
        }

        .auth-input::placeholder {
            color: #a0aec0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            color: #1a1f3a;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }

        .btn-admin {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: #ffffff;
        }

        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
        }

        .btn-secondary {
            background: #4a5568;
            color: #ffffff;
        }

        .user-welcome {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #1a1f3a;
        }

        .user-details h3 {
            font-size: 18px;
            color: #ffd700;
        }

        .user-details p {
            font-size: 14px;
            color: #a0aec0;
        }

        /* Panel de Administrador */
        .admin-panel {
            background: linear-gradient(135deg, #2d3748, #1a202c);
            margin: 20px auto;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #e53e3e;
            display: none;
        }

        .admin-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .admin-badge {
            background: #e53e3e;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .admin-stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-stat-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #ffd700;
            display: block;
        }

        .admin-stat-card .label {
            font-size: 12px;
            color: #a0aec0;
            text-transform: uppercase;
            margin-top: 5px;
        }

        .admin-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .control-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-section h4 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .control-section .btn {
            width: 100%;
            margin-bottom: 10px;
        }

        /* Votaciones */
        .voting-section {
            background: #1a202c;
            margin: 20px auto;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #2d3748;
            display: none;
        }

        .voting-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .voting-header h3 {
            color: #ffd700;
            font-size: 20px;
        }

        .vote-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .vote-btn {
            background: #2d3748;
            border: 2px solid #4a5568;
            color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .vote-btn:hover {
            border-color: #ffd700;
            background: #4a5568;
            transform: translateY(-2px);
        }

        .vote-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .vote-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .vote-progress {
            background: #2d3748;
            height: 8px;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .vote-bar {
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Status */
        .status-bar {
            background: #1a202c;
            padding: 15px 0;
            text-align: center;
            border-radius: 8px;
            margin: 20px auto;
            border: 1px solid #2d3748;
        }

        .status-connected {
            border-color: #38a169;
            background: rgba(56, 161, 105, 0.1);
        }

        .status-loading {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .status-error {
            border-color: #e53e3e;
            background: rgba(229, 62, 62, 0.1);
        }

        /* Tabla */
        .table-container {
            background: #1a202c;
            border-radius: 12px;
            border: 1px solid #2d3748;
            margin: 20px auto;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: linear-gradient(135deg, #2d3748, #4a5568);
            color: #ffd700;
            padding: 16px 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 11px;
            border-bottom: 2px solid #ffd700;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .th-positive {
            background: linear-gradient(135deg, #38a169, #2f855a);
        }

        .th-negative {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .th-results {
            background: linear-gradient(135deg, #805ad5, #6b46c1);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #2d3748;
            background: #1a202c;
        }

        tr:hover td {
            background: #2d3748;
        }

        .player-name {
            font-weight: 600;
            color: #ffd700;
            text-align: left;
            min-width: 150px;
        }

        .my-row td {
            background: rgba(56, 161, 105, 0.1) !important;
            border-color: #38a169;
        }

        .admin-row td {
            background: rgba(229, 62, 62, 0.1) !important;
            border-color: #e53e3e;
        }

        .stat-input {
            background: transparent;
            border: 1px solid #4a5568;
            color: #ffffff;
            padding: 6px 8px;
            border-radius: 4px;
            width: 100%;
            font-size: 12px;
            text-align: center;
        }

        .stat-input:focus {
            outline: none;
            border-color: #ffd700;
        }

        .stat-input:disabled {
            background: #2d3748;
            color: #a0aec0;
        }

        .score-cell {
            font-weight: 700;
            font-size: 14px;
        }

        .score-excellent {
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            color: #1a1f3a;
        }

        .score-very-good {
            background: linear-gradient(135deg, #38a169, #2f855a);
            color: #ffffff;
        }

        .score-good {
            background: linear-gradient(135deg, #3182ce, #2c5282);
            color: #ffffff;
        }

        .score-average {
            background: linear-gradient(135deg, #d69e2e, #b7791f);
            color: #ffffff;
        }

        .score-poor {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: #ffffff;
        }

        .penalty-score {
            color: #e53e3e;
            font-weight: 600;
        }

        .action-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }

        .action-btn:hover {
            background: #c53030;
        }

        /* Legends */
        .legend {
            display: flex;
            gap: 15px;
            margin: 20px auto;
            flex-wrap: wrap;
            justify-content: center;
        }

        .legend-item {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .legend-excellent {
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            color: #1a1f3a;
        }

        .legend-very-good {
            background: linear-gradient(135deg, #38a169, #2f855a);
            color: #ffffff;
        }

        .legend-good {
            background: linear-gradient(135deg, #3182ce, #2c5282);
            color: #ffffff;
        }

        .legend-average {
            background: linear-gradient(135deg, #d69e2e, #b7791f);
            color: #ffffff;
        }

        .legend-poor {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: #ffffff;
        }

        .legend-user {
            background: rgba(56, 161, 105, 0.2);
            border: 2px solid #38a169;
            color: #68d391;
        }

        .legend-admin {
            background: rgba(229, 62, 62, 0.2);
            border: 2px solid #e53e3e;
            color: #fc8181;
        }

        /* Actions */
        .actions-bar {
            display: flex;
            gap: 15px;
            margin: 20px auto;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Summary */
        .summary-section {
            background: #1a202c;
            margin: 20px auto;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #2d3748;
        }

        .summary-header {
            color: #ffd700;
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .ranking-list {
            list-style: none;
            padding: 0;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #2d3748;
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .ranking-position {
            font-size: 18px;
            margin-right: 15px;
        }

        .ranking-player {
            flex: 1;
            font-weight: 600;
        }

        .ranking-score {
            color: #ffd700;
            font-weight: 700;
        }

        .ranking-item.highlighted {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
            padding: 12px;
            border-bottom: 1px solid #ffd700;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .summary-stat {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-stat .label {
            font-size: 14px;
            color: #a0aec0;
            margin-bottom: 5px;
        }

        .summary-stat .value {
            font-size: 18px;
            font-weight: 700;
            color: #ffd700;
        }

        /* Formula */
        .formula-section {
            background: #1a202c;
            margin: 20px auto;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #2d3748;
        }

        .formula-section h4 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .formula-code {
            background: #0d1117;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffd700;
            font-family: 'Courier New', monospace;
            color: #58a6ff;
            margin: 15px 0;
            overflow-x: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .header-stats {
                justify-content: center;
            }

            .auth-form {
                flex-direction: column;
            }

            .auth-input {
                min-width: auto;
                width: 100%;
            }

            .user-welcome {
                flex-direction: column;
                text-align: center;
            }

            .admin-controls {
                grid-template-columns: 1fr;
            }

            .vote-options {
                grid-template-columns: 1fr;
            }

            .actions-bar {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* Loading */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            border-top-color: #ffd700;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .updating {
            background: rgba(255, 215, 0, 0.1) !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo">🏆</div>
                    <div class="title-section">
                        <h1>Primera C 25-26</h1>
                        <p class="subtitle">Competencia Oficial</p>
                    </div>
                </div>
                <div class="header-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="header-participants">0</span>
                        <span class="stat-label">Participantes</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="header-votes">0</span>
                        <span class="stat-label">Votos</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="header-leader">-</span>
                        <span class="stat-label">Líder</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Sistema de Usuario -->
        <div class="user-section">
            <div id="auth-form" class="auth-form">
                <input type="text" id="username" class="auth-input" placeholder="Ingresa tu nombre completo">
                <button class="btn btn-primary" onclick="loginUser()">Unirse a la Competencia</button>
                <button class="btn btn-admin" onclick="loginAsAdmin()">Acceso Administrador</button>
            </div>
            <div id="user-welcome" style="display: none;" class="user-welcome">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">A</div>
                    <div class="user-details">
                        <h3 id="user-name">Usuario</h3>
                        <p id="user-role">Participante</p>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="logoutUser()">Cerrar Sesión</button>
            </div>
        </div>

        <!-- Panel de Administrador -->
        <div id="admin-panel" class="admin-panel">
            <div class="admin-header">
                <h3 style="color: #ffd700;">Panel de Administración</h3>
                <div class="admin-badge">ADMINISTRADOR</div>
            </div>
            
            <div class="admin-stats">
                <div class="admin-stat-card">
                    <span class="value" id="admin-total-players">0</span>
                    <div class="label">Participantes</div>
                </div>
                <div class="admin-stat-card">
                    <span class="value" id="admin-total-votes">0</span>
                    <div class="label">Votos Totales</div>
                </div>
                <div class="admin-stat-card">
                    <span class="value" id="admin-leader">-</span>
                    <div class="label">Líder Actual</div>
                </div>
                <div class="admin-stat-card">
                    <span class="value" id="admin-avg-score">0.0</span>
                    <div class="label">Promedio</div>
                </div>
            </div>
            
            <div class="admin-controls">
                <div class="control-section">
                    <h4>🎮 Gestión de Competencia</h4>
                    <button class="btn btn-primary" onclick="addDemoPlayers()">Agregar Jugadores Demo</button>
                    <button class="btn btn-admin" onclick="resetSeason()">Nueva Temporada</button>
                    <button class="btn btn-secondary" onclick="clearVotes()">Limpiar Votaciones</button>
                </div>
                
                <div class="control-section">
                    <h4>📊 Reportes y Análisis</h4>
                    <button class="btn btn-primary" onclick="downloadDetailedReport()">Reporte Completo</button>
                    <button class="btn btn-primary" onclick="downloadVotingReport()">Reporte de Votaciones</button>
                    <button class="btn btn-secondary" onclick="backupData()">Crear Backup</button>
                </div>
                
                <div class="control-section">
                    <h4>🏆 Ceremonia</h4>
                    <button class="btn btn-primary" onclick="announceWinner()">Anunciar Ganador</button>
                    <button class="btn btn-secondary" onclick="freezeCompetition()">Congelar Competencia</button>
                </div>
            </div>
        </div>

        <!-- Sistema de Votaciones -->
        <div id="voting-section" class="voting-section">
            <div class="voting-header">
                <h3>🗳️ Votación Oficial del Balón de Oro</h3>
                <button class="btn btn-primary" onclick="toggleVoting()" id="voting-toggle">Ver Resultados</button>
            </div>
            
            <div id="voting-area">
                <p style="margin-bottom: 20px; color: #a0aec0;">Selecciona al jugador que consideras merece ganar el Balón de Oro 2025:</p>
                <div id="voting-options" class="vote-options"></div>
                <div id="vote-status" style="margin-top: 15px; text-align: center; color: #ffd700;"></div>
            </div>

            <div id="vote-results-area" style="display: none;">
                <h4 style="color: #ffd700; margin-bottom: 20px;">📊 Resultados de la Votación Oficial</h4>
                <div id="vote-results" class="vote-results"></div>
            </div>
        </div>

        <!-- Status -->
        <div id="status-indicator" class="status-bar status-loading">
            <span class="spinner"></span> Conectando al sistema oficial...
        </div>

        <!-- Leyenda -->
        <div class="legend">
            <div class="legend-item legend-excellent">🏆 Excelente (80+)</div>
            <div class="legend-item legend-very-good">⭐ Muy Bueno (70-79)</div>
            <div class="legend-item legend-good">🔵 Bueno (60-69)</div>
            <div class="legend-item legend-average">🟡 Regular (50-59)</div>
            <div class="legend-item legend-poor">🔴 Bajo (<50)</div>
            <div class="legend-item legend-user">💚 Tu Rendimiento</div>
            <div class="legend-item legend-admin">👑 Administrador</div>
        </div>

         <!-- Tabla Principal -->
        <div class="table-container">
            <div class="table-wrapper">
                <table id="statsTable">
                    <thead>
                        <tr>
                            <th rowspan="2">Jugador</th>
                            <th colspan="8" class="th-positive">📈 ESTADÍSTICAS POSITIVAS</th>
                            <th colspan="3" class="th-negative">📉 PENALIZACIONES</th>
                            <th colspan="3" class="th-results">🏆 RESULTADOS</th>
                            <th rowspan="2">Acciones</th>
                        </tr>
                        <tr>
                            <th class="th-positive">Goles</th>
                            <th class="th-positive">Asistencias</th>
                            <th class="th-positive">MVP</th>
                            <th class="th-positive">Goles Finales</th>
                            <th class="th-positive">Goles Puskas</th>
                            <th class="th-positive">Puertas en Cero</th>
                            <th class="th-positive">Consistencia</th>
                            <th class="th-positive">Impacto</th>
                            <th class="th-negative">T. Amarillas</th>
                            <th class="th-negative">T. Rojas</th>
                            <th class="th-negative">Offsides</th>
                            <th class="th-results">Base</th>
                            <th class="th-results">Penalización</th>
                            <th class="th-results">🏆 Final</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="16" style="text-align: center; padding: 40px; color: #a0aec0;">
                                <span class="spinner"></span>
                                <p style="margin-top: 10px;">Cargando datos de la competencia...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Acciones -->
        <div class="actions-bar">
            <button class="btn btn-primary" onclick="downloadCSV()">📥 Descargar CSV</button>
            <button class="btn btn-secondary" onclick="printTable()">🖨️ Imprimir Tabla</button>
        </div>

        <!-- Ranking y Estadísticas -->
        <div class="summary-section">
            <h3 class="summary-header">🏆 Clasificación Oficial del Balón de Oro</h3>
            <div id="ranking-container">
                <ol class="ranking-list" id="ranking-list">
                    <li class="ranking-item">
                        <span class="ranking-position">-</span>
                        <span class="ranking-player">Cargando ranking...</span>
                        <span class="ranking-score">-</span>
                    </li>
                </ol>
            </div>
            
            <div class="summary-stats">
                <div class="summary-stat">
                    <div class="label">🏆 Favorito</div>
                    <div class="value" id="summary-leader">-</div>
                </div>
                <div class="summary-stat">
                    <div class="label">📈 Promedio Top 3</div>
                    <div class="value" id="summary-avg-top3">0.0</div>
                </div>
                <div class="summary-stat">
                    <div class="label">⚠️ Más Penalizado</div>
                    <div class="value" id="summary-most-penalized">-</div>
                </div>
                <div class="summary-stat">
                    <div class="label">✨ Más Limpio</div>
                    <div class="value" id="summary-cleanest">-</div>
                </div>
            </div>
        </div>

        <!-- Fórmula -->
        <div class="formula-section">
            <h4>🧮 Fórmula Oficial del Balón de Oro</h4>
            <div class="formula-code">
                Puntos Base = (Goles × 0.8) + (Asistencias × 0.6) + (MVP × 1.2) + (Goles Finales × 3) + (Goles Puskas × 2.5) + (Puertas en Cero × 1.5) + (Consistencia × 2) + (Impacto × 1.5)
            </div>
            <p style="color: #a0aec0; margin-bottom: 15px;">La fórmula considera tanto el rendimiento ofensivo como defensivo del jugador.</p>
            
            <h4 style="margin-top: 25px;">⚠️ Sistema de Penalizaciones</h4>
            <div class="formula-code">
                Penalización = (Tarjetas Amarillas × 0.4) + (Tarjetas Rojas × 5) + (Offsides × 0.15)
            </div>
            <p style="color: #a0aec0;">Las penalizaciones reflejan la disciplina y precisión táctica del jugador.</p>
            
            <div style="margin-top: 20px; padding: 15px; background: rgba(255, 215, 0, 0.1); border-radius: 8px; border-left: 4px solid #ffd700;">
                <strong style="color: #ffd700;">🏆 Índice Final = Puntos Base - Penalizaciones</strong>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

    <script>
        // 🔧 CONFIGURACIÓN
        const firebaseConfig = {
            apiKey: "AIzaSyD27juR3l0TdLGsqwvjuw05Qwj0d4pdn8NW",
            authDomain: "temporada-primerac.firebaseapp.com",
            databaseURL: "https://temporada-primerac-default-rtdb.firebaseio.com/",
            projectId: "temporada-primerac"
        };

        // Variables globales
        let db = null;
        let playersRef = null;
        let votesRef = null;
        let isFirebaseConnected = false;
        let updateTimeout = null;
        let currentUser = null;
        let isAdmin = false;
        let showingVoteResults = false;
        let competitionFrozen = false;

        // 🔥 FIREBASE
        function initializeFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                playersRef = db.ref('players');
                votesRef = db.ref('votes');
                
                // Listeners
                playersRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    renderPlayersFromFirebase(data || {});
                    updateHeaderStats(data || {});
                    updateAdminStats(data || {});
                });

                votesRef.on('value', (snapshot) => {
                    const votes = snapshot.val();
                    updateVotingResults(votes || {});
                    updateHeaderStats(null, votes || {});
                    updateAdminStats(null, votes || {});
                });

                db.ref('.info/connected').on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        updateStatusIndicator('connected');
                        isFirebaseConnected = true;
                    } else {
                        updateStatusIndicator('disconnected');
                    }
                });
                
            } catch (error) {
                console.error('Error conectando Firebase:', error);
                updateStatusIndicator('error');
            }
        }

        // 👑 SISTEMA DE ADMINISTRADOR
        function loginAsAdmin() {
            const password = prompt('🔐 Ingrese la contraseña de administrador:');
            if (password === 'admin123') {
                currentUser = 'ADMIN';
                isAdmin = true;
                localStorage.setItem('ballonDorUser', 'ADMIN');
                localStorage.setItem('isAdmin', 'true');
                
                showUserInterface();
                document.getElementById('user-name').textContent = 'Administrador';
                document.getElementById('user-role').textContent = 'Control Total del Sistema';
                document.getElementById('user-avatar').textContent = '👑';
                document.getElementById('admin-panel').style.display = 'block';
            } else {
                alert('❌ Contraseña incorrecta');
            }
        }

        function loginUser() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('⚠️ Por favor ingrese su nombre completo');
                return;
            }

            currentUser = username;
            isAdmin = false;
            localStorage.setItem('ballonDorUser', username);
            localStorage.setItem('isAdmin', 'false');
            
            showUserInterface();
            document.getElementById('user-name').textContent = username;
            document.getElementById('user-role').textContent = 'Participante de la Competencia';
            document.getElementById('user-avatar').textContent = username.charAt(0).toUpperCase();

            ensureUserExists(username);
        }

        function showUserInterface() {
            document.getElementById('auth-form').style.display = 'none';
            document.getElementById('user-welcome').style.display = 'flex';
            document.getElementById('voting-section').style.display = 'block';
        }

        function logoutUser() {
            currentUser = null;
            isAdmin = false;
            localStorage.removeItem('ballonDorUser');
            localStorage.removeItem('isAdmin');
            
            document.getElementById('auth-form').style.display = 'flex';
            document.getElementById('user-welcome').style.display = 'none';
            document.getElementById('voting-section').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('username').value = '';
        }

        // 🎮 FUNCIONES DE ADMINISTRADOR
        function addDemoPlayers() {
            if (!isAdmin || !isFirebaseConnected) return;
            
            const demoPlayers = {
                'demo_messi': {
                    nombre: 'Lionel Messi',
                    goles: 35, asistencias: 12, mvp: 15, golesFinal: 3,
                    golesPuskas: 4, puertasCero: 2, consistencia: 9, impacto: 10,
                    amarillas: 5, rojas: 0, offsides: 8, createdAt: Date.now()
                },
                'demo_haaland': {
                    nombre: 'Erling Haaland',
                    goles: 42, asistencias: 8, mvp: 12, golesFinal: 2,
                    golesPuskas: 2, puertasCero: 1, consistencia: 8, impacto: 8,
                    amarillas: 3, rojas: 0, offsides: 12, createdAt: Date.now()
                },
                'demo_mbappe': {
                    nombre: 'Kylian Mbappé',
                    goles: 38, asistencias: 10, mvp: 14, golesFinal: 4,
                    golesPuskas: 3, puertasCero: 1, consistencia: 8, impacto: 9,
                    amarillas: 4, rojas: 0, offsides: 15, createdAt: Date.now()
                },
                'demo_benzema': {
                    nombre: 'Karim Benzema',
                    goles: 28, asistencias: 15, mvp: 16, golesFinal: 5,
                    golesPuskas: 5, puertasCero: 0, consistencia: 9, impacto: 9,
                    amarillas: 6, rojas: 1, offsides: 10, createdAt: Date.now()
                }
            };
            
            Object.entries(demoPlayers).forEach(([id, player]) => {
                playersRef.child(id).set(player);
            });
            
            alert('✅ Jugadores demo agregados exitosamente');
        }

        function resetSeason() {
            if (!isAdmin) return;
            
            if (confirm('⚠️ ¿Iniciar nueva temporada? Esto eliminará TODOS los datos.')) {
                if (confirm('🚨 CONFIRMACIÓN FINAL: Se perderán todos los datos permanentemente.')) {
                    playersRef.remove();
                    votesRef.remove();
                    alert('🔄 Nueva temporada iniciada exitosamente');
                }
            }
        }

        function clearVotes() {
            if (!isAdmin) return;
            
            if (confirm('¿Limpiar todas las votaciones?')) {
                votesRef.remove();
                alert('🗳️ Votaciones eliminadas');
            }
        }

        function freezeCompetition() {
            if (!isAdmin) return;
            
            competitionFrozen = !competitionFrozen;
            alert(competitionFrozen ? '❄️ Competencia congelada' : '🔥 Competencia reactivada');
        }

        function announceWinner() {
            if (!isAdmin) return;
            
            const rows = document.querySelectorAll('#tableBody tr');
            let winner = null;
            let highestScore = -1;
            
            rows.forEach(row => {
                const nameCell = row.querySelector('.player-name');
                const scoreCell = row.querySelector('.score-cell:last-child');
                if (nameCell && scoreCell) {
                    const score = parseFloat(scoreCell.textContent);
                    if (score > highestScore) {
                        highestScore = score;
                        winner = nameCell.textContent.replace(' (TÚ)', '').replace(' (ADMIN)', '').trim();
                    }
                }
            });
            
            if (winner) {
                alert(`🏆 GANADOR OFICIAL DEL BALÓN DE ORO 2025 🏆\n\n${winner}\nPuntuación Final: ${highestScore}\n\n¡Felicitaciones!`);
            }
        }

        function downloadDetailedReport() {
            if (!isAdmin) return;
            
            const rows = document.querySelectorAll('#tableBody tr');
            let csvContent = 'REPORTE OFICIAL DEL BALÓN DE ORO 2025\n';
            csvContent += 'Generado: ' + new Date().toLocaleString() + '\n\n';
            csvContent += 'Jugador,Goles,Asistencias,MVP,Goles Finales,Goles Puskas,Puertas en Cero,Consistencia,Impacto,Tarjetas Amarillas,Tarjetas Rojas,Offsides,Puntos Base,Penalización,Índice Final\n';
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('.stat-input');
                const cells = row.querySelectorAll('td');
                if (inputs.length > 0) {
                    const data = [];
                    data.push(cells[0].textContent.replace(' (TÚ)', '').replace(' (ADMIN)', '').trim());
                    inputs.forEach(input => data.push(input.value || '0'));
                    data.push(cells[12].textContent, cells[13].textContent, cells[14].textContent);
                    csvContent += `"${data[0]}",${data.slice(1).join(',')}\n`;
                }
            });
            
            downloadFile(csvContent, 'reporte_balon_oro_2025.csv');
        }

        function downloadVotingReport() {
            if (!isAdmin) return;
            
            votesRef.once('value').then((snapshot) => {
                const votes = snapshot.val() || {};
                let csvContent = 'REPORTE DE VOTACIONES OFICIALES\n';
                csvContent += 'Generado: ' + new Date().toLocaleString() + '\n\n';
                csvContent += 'Votante,Candidato Votado,Fecha y Hora\n';
                
                Object.entries(votes).forEach(([voter, vote]) => {
                    const date = new Date(vote.timestamp).toLocaleString();
                    csvContent += `"${voter}","${vote.playerName}","${date}"\n`;
                });
                
                downloadFile(csvContent, 'votaciones_balon_oro_2025.csv');
            });
        }

        function backupData() {
            if (!isAdmin) return;
            
            Promise.all([
                playersRef.once('value'),
                votesRef.once('value')
            ]).then(([playersSnapshot, votesSnapshot]) => {
                const backup = {
                    fecha: new Date().toISOString(),
                    version: "2025.1",
                    players: playersSnapshot.val() || {},
                    votes: votesSnapshot.val() || {},
                    metadata: {
                        totalPlayers: Object.keys(playersSnapshot.val() || {}).length,
                        totalVotes: Object.keys(votesSnapshot.val() || {}).length
                    }
                };
                
                downloadFile(JSON.stringify(backup, null, 2), `backup_balon_oro_${new Date().toISOString().split('T')[0]}.json`);
                alert('💾 Backup creado exitosamente');
            });
        }

        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 📊 ESTADÍSTICAS
        function updateHeaderStats(playersData, votesData) {
            if (playersData) {
                const players = Object.values(playersData);
                document.getElementById('header-participants').textContent = players.length;
                
                if (players.length > 0) {
                    const leader = players.reduce((prev, current) => {
                        const prevScore = calculateFinalScore(prev);
                        const currentScore = calculateFinalScore(current);
                        return prevScore > currentScore ? prev : current;
                    });
                    document.getElementById('header-leader').textContent = leader.nombre.split(' ')[0];
                }
            }
            
            if (votesData) {
                document.getElementById('header-votes').textContent = Object.keys(votesData).length;
            }
        }

        function updateAdminStats(playersData, votesData) {
            if (!isAdmin) return;
            
            if (playersData) {
                const players = Object.values(playersData);
                document.getElementById('admin-total-players').textContent = players.length;
                
                if (players.length > 0) {
                    const scores = players.map(p => calculateFinalScore(p));
                    const avgScore = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
                    document.getElementById('admin-avg-score').textContent = avgScore;
                    
                    const leader = players.reduce((prev, current) => {
                        const prevScore = calculateFinalScore(prev);
                        const currentScore = calculateFinalScore(current);
                        return prevScore > currentScore ? prev : current;
                    });
                    document.getElementById('admin-leader').textContent = leader.nombre.split(' ')[0];
                }
            }
            
            if (votesData) {
                document.getElementById('admin-total-votes').textContent = Object.keys(votesData).length;
            }
        }

        // 👥 SISTEMA DE USUARIOS
        function ensureUserExists(username) {
            if (!isFirebaseConnected) return;
            
            const playerId = username.replace(/[.#$[\]]/g, '_');
            playersRef.child(playerId).once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    const newPlayer = {
                        nombre: username,
                        goles: 0, asistencias: 0, mvp: 0, golesFinal: 0,
                        golesPuskas: 0, puertasCero: 0, consistencia: 5, impacto: 5,
                        amarillas: 0, rojas: 0, offsides: 0,
                        createdAt: Date.now()
                    };
                    playersRef.child(playerId).set(newPlayer);
                }
            });
        }

        function updateStatusIndicator(status) {
            const indicator = document.getElementById('status-indicator');
            
            switch(status) {
                case 'connected':
                    indicator.className = 'status-bar status-connected';
                    indicator.innerHTML = '✅ Conectado al sistema oficial del Balón de Oro';
                    break;
                case 'disconnected':
                    indicator.className = 'status-bar status-error';
                    indicator.innerHTML = '⚠️ Conexión perdida - Reintentando...';
                    break;
                case 'error':
                    indicator.className = 'status-bar status-error';
                    indicator.innerHTML = '❌ Error de conexión al sistema';
                    break;
                default:
                    indicator.className = 'status-bar status-loading';
                    indicator.innerHTML = '<span class="spinner"></span> Conectando al sistema oficial...';
            }
        }

        // 🔧 FUNCIÓN CORREGIDA PARA RENDERIZAR JUGADORES
        function renderPlayersFromFirebase(data) {
            const tbody = document.getElementById('tableBody');
            if (!tbody) {
                console.error('No se encontró el elemento tableBody');
                return;
            }
            
            tbody.innerHTML = '';
            
            const playersData = data || {};
            const playerKeys = Object.keys(playersData);
            
            console.log('Renderizando jugadores:', playerKeys.length);
            
            if (playerKeys.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="16" style="text-align: center; padding: 40px; color: #a0aec0;">
                            <p>No hay jugadores registrados</p>
                            <p style="margin-top: 10px; font-size: 12px;">Únete a la competencia para comenzar</p>
                        </td>
                    </tr>
                `;
            } else {
                playerKeys.forEach(playerId => {
                    const player = playersData[playerId];
                    const row = createPlayerRow(playerId, player);
                    tbody.appendChild(row);
                });
            }
            
            // Esperar un momento para que el DOM se actualice antes de calcular el ranking
            setTimeout(() => {
                updateRanking();
                updateVotingOptions();
            }, 100);
        }

        function createPlayerRow(playerId, player) {
            const row = document.createElement('tr');
            row.id = playerId;
            
            // Calcular puntuaciones
            const puntosBase = calculateBalonOro(
                player.goles, player.asistencias, player.mvp, 
                player.golesFinal, player.golesPuskas, player.puertasCero,
                player.consistencia, player.impacto
            );
            const penalizaciones = calculatePenalties(player.amarillas, player.rojas, player.offsides);
            const indiceFinal = Math.round((puntosBase - penalizaciones) * 10) / 10;
            
            // Verificar tipo de usuario
            const isCurrentUser = currentUser && player.nombre === currentUser && !isAdmin;
            const isAdminRow = isAdmin && currentUser === 'ADMIN';
            
            if (isCurrentUser) {
                row.classList.add('my-row');
            } else if (isAdminRow) {
                row.classList.add('admin-row');
            }

            // Permisos de edición
            const canEdit = isCurrentUser || isAdmin;
            const inputDisabled = canEdit && !competitionFrozen ? '' : 'disabled';
            
            let userLabel = '';
            if (isCurrentUser) userLabel = ' (TÚ)';
            else if (isAdminRow) userLabel = ' (ADMIN)';
            
            row.innerHTML = `
                <td class="player-name">${player.nombre}${userLabel}</td>
                <td><input type="number" min="0" value="${player.goles}" class="stat-input" onchange="updatePlayer('${playerId}', 'goles', this.value)" ${inputDisabled}></td>
                <td><input type="number" min="0" value="${player.asistencias}" class="stat-input" onchange="updatePlayer('${playerId}', 'asistencias', this.value)" ${inputDisabled}></td>
                <td><input type="number" min="0" value="${player.mvp}" class="stat-input" onchange="updatePlayer('${playerId}', 'mvp', this.value)" ${inputDisabled}></td>
                <td><input type="number" min="0" value="${player.golesFinal}" class="stat-input" onchange="updatePlayer('${playerId}', 'golesFinal', this.value)" ${inputDisabled}></td>
                <td><input type="number" min="0" value="${player.golesPuskas}" class="stat-input" onchange="updatePlayer('${playerId}', 'golesPuskas', this.value)" ${inputDisabled}></td>
                <td><input type="number" min="0" value="${player.puertasCero || 0}" class="stat-input" onchange="updatePlayer('${playerId}', 'puertasCero', this.value)" ${inputDisabled}></td>
                <td><input type="number" min="1" max="10" value="${player.consistencia}" class="stat-input" onchange="updatePlayer('${playerId}', 'consistencia', this.value)" ${inputDisabled}></td>
                <td><input type="number" min="1" max="10" value="${player.impacto}" class="stat-input" onchange="updatePlayer('${playerId}', 'impacto', this.value)" ${inputDisabled}></td>
                <td><input type="number" min="0" value="${player.amarillas}" class="stat-input" onchange="updatePlayer('${playerId}', 'amarillas', this.value)" ${inputDisabled}></td>
                <td><input type="number" min="0" value="${player.rojas}" class="stat-input" onchange="updatePlayer('${playerId}', 'rojas', this.value)" ${inputDisabled}></td>
                <td><input type="number" min="0" value="${player.offsides}" class="stat-input" onchange="updatePlayer('${playerId}', 'offsides', this.value)" ${inputDisabled}></td>
                <td class="score-cell">${puntosBase}</td>
                <td class="score-cell penalty-score">-${penalizaciones}</td>
                <td class="score-cell ${getScoreClass(indiceFinal)}">${indiceFinal}</td>
                <td>${(isCurrentUser || isAdmin) ? `<button class="action-btn" onclick="deletePlayer('${playerId}')">🗑️</button>` : '-'}</td>
            `;
            
            return row;
        }

        function updatePlayer(playerId, field, value) {
            if (!isFirebaseConnected || competitionFrozen) return;
            
            // Verificar permisos
            if (!isAdmin) {
                playersRef.child(playerId).once('value').then((snapshot) => {
                    const player = snapshot.val();
                    if (player && player.nombre !== currentUser) {
                        alert('⚠️ Solo puedes editar tus propias estadísticas');
                        return;
                    }
                });
            }
            
            const row = document.getElementById(playerId);
            if (row) {
                row.classList.add('updating');
                
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(() => {
                    playersRef.child(playerId).child(field).set(parseFloat(value) || 0);
                    row.classList.remove('updating');
                }, 500);
            }
        }

        function deletePlayer(playerId) {
            if (!isFirebaseConnected) return;
            
            let confirmMsg = '';
            if (isAdmin) {
                confirmMsg = '¿Eliminar este jugador de la competencia?';
            } else {
                confirmMsg = '¿Salir de la competencia? Se eliminarán tus datos.';
            }
            
            if (confirm(confirmMsg)) {
                playersRef.child(playerId).remove();
                votesRef.child(playerId).remove();
                
                if (!isAdmin) {
                    logoutUser();
                }
            }
        }

        // 🏆 FUNCIÓN CORREGIDA PARA ACTUALIZAR RANKING
        function updateRanking() {
            // Primero verificar si hay filas en la tabla
            const rows = document.querySelectorAll('#tableBody tr');
            const candidatos = [];
            
            // Debug: verificar cuántas filas encontramos
            console.log('Filas encontradas:', rows.length);
            
            rows.forEach((row, index) => {
                const nameCell = row.querySelector('.player-name');
                const scoreCells = row.querySelectorAll('.score-cell');
                
                // Debug: verificar estructura de cada fila
                console.log(`Fila ${index}:`, {
                    nameCell: nameCell?.textContent,
                    scoreCells: scoreCells.length
                });
                
                // La última celda con clase score-cell debería ser el índice final
                const finalScoreCell = scoreCells[scoreCells.length - 1];
                
                if (nameCell && finalScoreCell && nameCell.textContent.trim() !== '') {
                    const nombre = nameCell.textContent.replace(' (TÚ)', '').replace(' (ADMIN)', '').trim();
                    const finalScoreText = finalScoreCell.textContent.trim();
                    const finalScore = parseFloat(finalScoreText);
                    
                    // Verificar que el score es un número válido
                    if (!isNaN(finalScore) && nombre !== '') {
                        candidatos.push({ nombre, indiceFinal: finalScore });
                        console.log('Candidato agregado:', { nombre, indiceFinal: finalScore });
                    }
                }
            });
            
            console.log('Total candidatos:', candidatos.length);
            
            // Ordenar por puntuación descendente
            candidatos.sort((a, b) => b.indiceFinal - a.indiceFinal);
            
            const rankingList = document.getElementById('ranking-list');
            if (!rankingList) {
                console.error('No se encontró el elemento ranking-list');
                return;
            }
            
            let rankingHTML = '';
            
            if (candidatos.length === 0) {
                rankingHTML = `
                    <li class="ranking-item">
                        <span class="ranking-position">-</span>
                        <span class="ranking-player">No hay datos disponibles</span>
                        <span class="ranking-score">-</span>
                    </li>
                `;
            } else {
                candidatos.slice(0, 10).forEach((candidato, index) => {
                    const position = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}°`;
                    const isCurrentUserInRanking = (currentUser && candidato.nombre === currentUser) || 
                                                   (isAdmin && currentUser === 'ADMIN');
                    const highlightClass = isCurrentUserInRanking ? 'highlighted' : '';
                    
                    rankingHTML += `
                        <li class="ranking-item ${highlightClass}">
                            <span class="ranking-position">${position}</span>
                            <span class="ranking-player">${candidato.nombre}</span>
                            <span class="ranking-score">${candidato.indiceFinal} pts</span>
                        </li>
                    `;
                });
            }
            
            rankingList.innerHTML = rankingHTML;
            
            // Actualizar estadísticas de resumen
            updateSummaryStats(candidatos);
        }

        function updateSummaryStats(candidatos) {
            // Actualizar estadísticas de resumen
            const summaryLeader = document.getElementById('summary-leader');
            const summaryAvgTop3 = document.getElementById('summary-avg-top3');
            const summaryMostPenalized = document.getElementById('summary-most-penalized');
            const summaryCleanest = document.getElementById('summary-cleanest');
            
            if (candidatos.length > 0) {
                if (summaryLeader) {
                    summaryLeader.textContent = `${candidatos[0].nombre} (${candidatos[0].indiceFinal})`;
                }
                
                const top3 = candidatos.slice(0, 3);
                if (summaryAvgTop3 && top3.length > 0) {
                    const promedioTop3 = (top3.reduce((sum, c) => sum + c.indiceFinal, 0) / top3.length).toFixed(1);
                    summaryAvgTop3.textContent = promedioTop3;
                }
                
                if (candidatos.length > 1) {
                    if (summaryMostPenalized) {
                        summaryMostPenalized.textContent = candidatos[candidatos.length - 1].nombre;
                    }
                    if (summaryCleanest) {
                        summaryCleanest.textContent = candidatos[0].nombre;
                    }
                }
            } else {
                // Si no hay candidatos, mostrar valores por defecto
                if (summaryLeader) summaryLeader.textContent = '-';
                if (summaryAvgTop3) summaryAvgTop3.textContent = '0.0';
                if (summaryMostPenalized) summaryMostPenalized.textContent = '-';
                if (summaryCleanest) summaryCleanest.textContent = '-';
            }
        }

        // 🗳️ SISTEMA DE VOTACIONES
        function updateVotingOptions() {
            const votingOptions = document.getElementById('voting-options');
            if (!votingOptions) return;

            const rows = document.querySelectorAll('#tableBody tr');
            let optionsHTML = '';

            rows.forEach(row => {
                const nameCell = row.querySelector('.player-name');
                if (nameCell) {
                    const playerName = nameCell.textContent.replace(' (TÚ)', '').replace(' (ADMIN)', '').trim();
                    const playerId = row.id;
                    if (playerName !== '') {
                        optionsHTML += `<button class="vote-btn" onclick="voteForPlayer('${playerId}', '${playerName}')">${playerName}</button>`;
                    }
                }
            });

            votingOptions.innerHTML = optionsHTML;
        }

        function voteForPlayer(playerId, playerName) {
            if (!currentUser || !isFirebaseConnected) {
                alert('⚠️ Debe iniciar sesión para votar');
                return;
            }

            const voterId = currentUser === 'ADMIN' ? 'ADMIN' : currentUser.replace(/[.#$[\]]/g, '_');
            
            votesRef.child(voterId).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    if (confirm('Ya has emitido tu voto. ¿Deseas cambiarlo?')) {
                        votesRef.child(voterId).set({
                            votedFor: playerId,
                            playerName: playerName,
                            timestamp: Date.now()
                        });
                        document.getElementById('vote-status').innerHTML = `✅ Has votado por <strong>${playerName}</strong>`;
                    }
                } else {
                    votesRef.child(voterId).set({
                        votedFor: playerId,
                        playerName: playerName,
                        timestamp: Date.now()
                    });
                    document.getElementById('vote-status').innerHTML = `✅ Has votado por <strong>${playerName}</strong>`;
                }
            });
        }

        function updateVotingResults(votes) {
            const voteResults = document.getElementById('vote-results');
            if (!voteResults) return;

            const voteCounts = {};
            const totalVotes = Object.keys(votes).length;

            Object.values(votes).forEach(vote => {
                const playerName = vote.playerName;
                voteCounts[playerName] = (voteCounts[playerName] || 0) + 1;
            });

            let resultsHTML = '';
            Object.entries(voteCounts)
                .sort(([,a], [,b]) => b - a)
                .forEach(([playerName, count]) => {
                    const percentage = totalVotes > 0 ? ((count / totalVotes) * 100).toFixed(1) : 0;
                    resultsHTML += `
                        <div class="vote-item">
                            <h4 style="margin-bottom: 10px; color: #ffd700;">${playerName}</h4>
                            <p style="margin-bottom: 10px; color: #a0aec0;">${count} votos (${percentage}%)</p>
                            <div class="vote-progress">
                                <div class="vote-bar" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                });

            voteResults.innerHTML = resultsHTML || '<p style="text-align: center; color: #a0aec0;">No hay votos registrados</p>';

            if (currentUser) {
                const voterId = currentUser === 'ADMIN' ? 'ADMIN' : currentUser.replace(/[.#$[\]]/g, '_');
                const userVote = votes[voterId];
                if (userVote) {
                    document.getElementById('vote-status').innerHTML = `✅ Has votado por <strong>${userVote.playerName}</strong>`;
                } else {
                    document.getElementById('vote-status').innerHTML = '🗳️ Aún no has emitido tu voto';
                }
            }
        }

        function toggleVoting() {
            const votingArea = document.getElementById('voting-area');
            const resultsArea = document.getElementById('vote-results-area');
            const toggleBtn = document.getElementById('voting-toggle');

            if (showingVoteResults) {
                votingArea.style.display = 'block';
                resultsArea.style.display = 'none';
                toggleBtn.textContent = 'Ver Resultados';
                showingVoteResults = false;
            } else {
                votingArea.style.display = 'none';
                resultsArea.style.display = 'block';
                toggleBtn.textContent = 'Votar';
                showingVoteResults = true;
            }
        }

        // 🧮 CÁLCULOS
        function calculateBalonOro(goles, asistencias, mvp, golesFinal, golesPuskas, puertasCero, consistencia, impacto) {
            const puntosBase = (goles * 0.8) + (asistencias * 0.6) + (mvp * 1.2) + 
                              (golesFinal * 3) + (golesPuskas * 2.5) + (puertasCero * 1.5) +
                              (consistencia * 2) + (impacto * 1.5);
            return Math.round(puntosBase * 10) / 10;
        }

        function calculatePenalties(amarillas, rojas, offsides) {
            const penalizacion = (amarillas * 0.4) + (rojas * 5) + (offsides * 0.15);
            return Math.round(penalizacion * 10) / 10;
        }

        function calculateFinalScore(player) {
            const base = calculateBalonOro(
                player.goles, player.asistencias, player.mvp, 
                player.golesFinal, player.golesPuskas, player.puertasCero || 0,
                player.consistencia, player.impacto
            );
            const penalty = calculatePenalties(player.amarillas, player.rojas, player.offsides);
            return Math.round((base - penalty) * 10) / 10;
        }

        function getScoreClass(score) {
            if (score >= 80) return 'score-excellent';
            if (score >= 70) return 'score-very-good';
            if (score >= 60) return 'score-good';
            if (score >= 50) return 'score-average';
            return 'score-poor';
        }

        // 📁 UTILIDADES
        function downloadCSV() {
            const rows = document.querySelectorAll('#tableBody tr');
            let csvContent = 'BALÓN DE ORO 2025 - DATOS OFICIALES\n';
            csvContent += 'Exportado: ' + new Date().toLocaleString() + '\n\n';
            csvContent += 'Jugador,Goles,Asistencias,MVP,Goles Finales,Goles Puskas,Puertas en Cero,Consistencia,Impacto,Tarjetas Amarillas,Tarjetas Rojas,Offsides,Puntos Base,Penalización,Índice Final\n';
            
            rows.forEach(row => {
                const inputs = row.querySelectorAll('.stat-input');
                const cells = row.querySelectorAll('td');
                if (inputs.length > 0) {
                    const data = [];
                    data.push(cells[0].textContent.replace(' (TÚ)', '').replace(' (ADMIN)', '').trim());
                    inputs.forEach(input => data.push(input.value || '0'));
                    data.push(cells[12].textContent, cells[13].textContent, cells[14].textContent);
                    csvContent += `"${data[0]}",${data.slice(1).join(',')}\n`;
                }
            });
            
            downloadFile(csvContent, 'balon_oro_2025_oficial.csv');
        }

        function printTable() {
            window.print();
        }

        // 🚀 INICIALIZACIÓN
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🏆 Iniciando Sistema Oficial del Balón de Oro 2025...');
            initializeFirebase();
            
            const savedUser = localStorage.getItem('ballonDorUser');
            const savedAdmin = localStorage.getItem('isAdmin') === 'true';
            
            if (savedUser) {
                document.getElementById('username').value = savedUser;
                if (savedAdmin && savedUser === 'ADMIN') {
                    // Auto-login para admin si ya estaba logueado
                    currentUser = 'ADMIN';
                    isAdmin = true;
                    showUserInterface();
                    document.getElementById('user-name').textContent = 'Administrador';
                    document.getElementById('user-role').textContent = 'Control Total del Sistema';
                    document.getElementById('user-avatar').textContent = '👑';
                    document.getElementById('admin-panel').style.display = 'block';
                } else if (!savedAdmin) {
                    loginUser();
                }
            }
        });
    </script>
</body>
</html>